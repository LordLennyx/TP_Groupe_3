cat > .github/workflows/llm-review.yml << 'EOF'
name: Revue LLM & Notification

on:
  pull_request:
    types: [opened, synchronize]
    branches: [develop]

jobs:
  review_and_notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get PR Diff
        id: diff
        run: |
          curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
               -H "Accept: application/vnd.github.v3.diff" \
               "$$ {{ github.api_url }}/repos/ $${{ github.repository }}/pulls/${{ github.event.pull_request.number }}" > pr_diff.txt
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          cat pr_diff.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Call Gemini API
        id: gemini
        run: |
          RESPONSE=$$ (curl -s -X POST "https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key= $${{ secrets.GEMINI_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "contents": [{
                "parts": [{
                  "text": "Tu es un relecteur de code expert. Analyse ce diff de PR. Si le code est bon, fournis des pistes d\'amélioration. Si le code contient des bugs, liste-les. Réponds en français.\n\nDiff:\n${{ steps.diff.outputs.diff }}"
                }]
              }]
            }')
          LLM_RESPONSE=$(echo $RESPONSE | jq -r '.candidates[0].content.parts[0].text')
          echo "llm_response<<EOF" >> $GITHUB_OUTPUT
          echo "$LLM_RESPONSE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const response = await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `Revue LLM:\n\`\`\`\n${{ steps.gemini.outputs.llm_response }}\n\`\`\`\n\n@${{ github.actor }}`
            });

      - name: Send Email
        uses: dawidd6/action-send-mail@v4
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "Revue LLM pour PR #$$ {{ github.event.pull_request.number }} par @ $${{ github.actor }}"
          to: ${{ secrets.TEAM_EMAIL_LIST }}
          from: ${{ secrets.MAIL_USERNAME }}
          body: "Voici la revue générée par l'IA : \n\n${{ steps.gemini.outputs.llm_response }}"
EOF
