name: LLM Review

on:
  pull_request:
    branches: [develop]
    types: [opened, synchronize]

jobs:
  review_and_notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Call Gemini and comment
        uses: actions/github-script@v7
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          script: |
            const apiKey = process.env.GEMINI_API_KEY;
            const prompt = "Tu es un relecteur de code. Fais un commentaire court et poli sur cette pull request GitHub pour un TP.";

            const res = await fetch(
              "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=" + apiKey,
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  contents: [
                    {
                      parts: [
                        { text: prompt }
                      ]
                    }
                  ]
                })
              }
            );

            if (!res.ok) {
              throw new Error(`Gemini API error: ${res.status} ${res.statusText}`);
            }

            const data = await res.json();
            const text =
              data?.candidates?.[0]?.content?.parts?.[0]?.text ??
              "Impossible de g√©n√©rer le texte de revue.";

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: "ü§ñ Revue automatique Gemini :\n\n" + text
            });
